<!DOCTYPE html>
<html>
<head>
    <title>Trekers Lane Test</title>
</head>
<body>
    <h2>Testing Trekers Lane Loading</h2>
    <button id="load-btn">Load Trekers</button>
    <pre id="results"></pre>

    <script>
        async function testLanes() {
            const resultsEl = document.getElementById('results');
            resultsEl.textContent = 'Loading...';

            try {
                // Fetch Trekers data
                const response = await fetch('http://localhost:8000/api/game/trekers');
                const gameData = await response.json();

                // Parse the Twee content
                const passages = [];
                const lanes = new Map();
                const passageChunks = gameData.storyContent.split(/^:: /m).filter(chunk => chunk.trim());

                passageChunks.forEach(chunk => {
                    const lines = chunk.split('\n');
                    const headerLine = lines[0];
                    const headerMatch = headerLine.match(/^([^\[\n\r]+?)(?:\s*\[([^\]]*)\])?\s*$/);

                    if (headerMatch) {
                        const title = headerMatch[1].trim();
                        const tagString = headerMatch[2] ? headerMatch[2].trim() : '';
                        const content = lines.slice(1).join('\n').trim();

                        // Parse tags for lane assignment
                        const tags = tagString.split(/\s+/).filter(t => t);
                        let laneName = 'Main';

                        tags.forEach(tag => {
                            if (tag.startsWith('$lane:')) {
                                laneName = tag.substring(6);
                            }
                        });

                        // Track lanes
                        if (!lanes.has(laneName)) {
                            lanes.set(laneName, []);
                        }
                        lanes.get(laneName).push(title);

                        passages.push({
                            title,
                            lane: laneName,
                            tags: tags.filter(t => !t.startsWith('$lane:')),
                            contentLength: content.length
                        });
                    }
                });

                // Display results
                let output = `Trekers Lanes Analysis\n`;
                output += `====================\n\n`;
                output += `Total Passages: ${passages.length}\n`;
                output += `Total Lanes: ${lanes.size}\n\n`;

                output += `Lanes Found:\n`;
                output += `------------\n`;
                const sortedLanes = Array.from(lanes.keys()).sort();
                sortedLanes.forEach(lane => {
                    const passages = lanes.get(lane);
                    output += `\n${lane}: ${passages.length} passages\n`;
                    passages.forEach(p => output += `  - ${p}\n`);
                });

                // Check for metadata passages
                const metadataPassages = passages.filter(p =>
                    p.title === 'Start' ||
                    p.title === 'StoryTitle' ||
                    p.title === 'StoryAuthor'
                );
                output += `\n\nMetadata Passages: ${metadataPassages.length}\n`;
                metadataPassages.forEach(p => output += `  - ${p.title} (lane: ${p.lane})\n`);

                resultsEl.textContent = output;

                // Log for debugging
                console.log('Lanes Map:', lanes);
                console.log('Passages:', passages);

            } catch (error) {
                resultsEl.textContent = `Error: ${error.message}`;
                console.error('Error:', error);
            }
        }

        document.getElementById('load-btn').addEventListener('click', testLanes);
    </script>
</body>
</html>